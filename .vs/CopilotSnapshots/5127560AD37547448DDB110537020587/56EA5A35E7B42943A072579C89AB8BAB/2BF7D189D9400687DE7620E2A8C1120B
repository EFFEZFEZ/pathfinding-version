/**
 * main.js
 * Point d'entrée principal de l'application
 * Orchestre tous les modules et gère l'interface utilisateur
 */

import { DataManager } from './dataManager.js';
import { TimeManager } from './timeManager.js';
import { TripScheduler } from './tripScheduler.js';
import { BusPositionCalculator } from './busPositionCalculator.js';
import { MapRenderer } from './mapRenderer.js';

let dataManager;
let timeManager;
let tripScheduler;
let busPositionCalculator;
let mapRenderer;
let visibleRoutes = new Set();

async function initializeApp() {
    dataManager = new DataManager();
    
    try {
        await dataManager.loadAllData();
        
        mapRenderer = new MapRenderer('map');
        mapRenderer.initializeMap();
        
        timeManager = new TimeManager();
        tripScheduler = new TripScheduler(dataManager);
        busPositionCalculator = new BusPositionCalculator(dataManager);
        
        initializeRouteFilter();
        
        // Correction: utiliser dataManager.geoJson
        if (dataManager.geoJson) {
            mapRenderer.displayMultiColorRoutes(dataManager.geoJson, dataManager, visibleRoutes);
        }
        
        setupEventListeners();
        
        document.getElementById('instructions').classList.remove('hidden');
        updateDataStatus('Données chargées', 'loaded');
        
        updateData();
        
    } catch (error) {
        console.error('Erreur lors de l\'initialisation:', error);
        updateDataStatus('Erreur de chargement', 'error');
    }
}

function initializeRouteFilter() {
    const routeCheckboxesContainer = document.getElementById('route-checkboxes');
    routeCheckboxesContainer.innerHTML = '';
    visibleRoutes.clear();

    // Regrouper les routes par catégorie
    const categories = {};
    dataManager.routes.forEach(route => {
        if (!categories[route.category]) categories[route.category] = [];
        categories[route.category].push(route);
    });

    // Pour chaque catégorie, créer un bloc avec bouton de sélection
    Object.keys(categories).forEach(category => {
        // Bloc catégorie
        const catDiv = document.createElement('div');
        catDiv.className = 'route-category-block';

        // Titre + bouton tout cocher/décocher
        const catHeader = document.createElement('div');
        catHeader.className = 'route-category-header';
        catHeader.innerHTML = `<strong>${category}</strong>`;
        const catToggle = document.createElement('button');
        catToggle.className = 'btn-small';
        catToggle.textContent = 'Tout cocher/décocher';
        catToggle.addEventListener('click', () => {
            // Toggle tous les checkboxes de cette catégorie
            const checked = Array.from(catDiv.querySelectorAll('input[type=checkbox]')).some(cb => !cb.checked);
            Array.from(catDiv.querySelectorAll('input[type=checkbox]')).forEach(cb => {
                cb.checked = checked;
            });
            handleRouteFilterChange();
        });
        catHeader.appendChild(catToggle);
        catDiv.appendChild(catHeader);

        // Lignes de la catégorie
        categories[category].forEach(route => {
            visibleRoutes.add(route.route_id);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'route-checkbox-item';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `route-${route.route_id}`;
            checkbox.checked = true;
            checkbox.addEventListener('change', () => handleRouteFilterChange());
            const routeColor = route.route_color ? `#${route.route_color}` : '#3388ff';
            const textColor = route.route_text_color ? `#${route.route_text_color}` : '#ffffff';
            const badge = document.createElement('div');
            badge.className = 'route-badge';
            badge.style.backgroundColor = routeColor;
            badge.style.color = textColor;
            badge.textContent = route.route_short_name || route.route_id;
            const label = document.createElement('span');
            label.className = 'route-name';
            label.textContent = route.route_long_name || route.route_short_name || route.route_id;
            itemDiv.appendChild(checkbox);
            itemDiv.appendChild(badge);
            itemDiv.appendChild(label);
            catDiv.appendChild(itemDiv);
        });
        routeCheckboxesContainer.appendChild(catDiv);
    });
}

function handleRouteFilterChange() {
    visibleRoutes.clear();
    
    dataManager.routes.forEach(route => {
        const checkbox = document.getElementById(`route-${route.route_id}`);
        if (checkbox && checkbox.checked) {
            visibleRoutes.add(route.route_id);
        }
    });
    
    // Correction: utiliser dataManager.geoJson
    if (dataManager.geoJson) {
        mapRenderer.displayMultiColorRoutes(dataManager.geoJson, dataManager, visibleRoutes);
    }
    
    updateData();
}

function setupEventListeners() {
    document.getElementById('btn-play').addEventListener('click', () => {
        timeManager.play();
    });
    
    document.getElementById('btn-pause').addEventListener('click', () => {
        timeManager.pause();
    });
    
    document.getElementById('btn-refresh').addEventListener('click', () => {
        timeManager.reset();
        updateData();
    });
    
    document.getElementById('close-instructions').addEventListener('click', () => {
        document.getElementById('instructions').classList.add('hidden');
    });
    
    document.getElementById('btn-toggle-filter').addEventListener('click', () => {
        document.getElementById('route-filter-panel').classList.toggle('hidden');
    });
    
    document.getElementById('close-filter').addEventListener('click', () => {
        document.getElementById('route-filter-panel').classList.add('hidden');
    });
    
    document.getElementById('select-all-routes').addEventListener('click', () => {
        dataManager.routes.forEach(route => {
            const checkbox = document.getElementById(`route-${route.route_id}`);
            if (checkbox) checkbox.checked = true;
        });
        handleRouteFilterChange();
    });
    
    document.getElementById('deselect-all-routes').addEventListener('click', () => {
        dataManager.routes.forEach(route => {
            const checkbox = document.getElementById(`route-${route.route_id}`);
            if (checkbox) checkbox.checked = false;
        });
        handleRouteFilterChange();
    });
    
    // Mise à jour temps réel pilotée uniquement par le TimeManager
    timeManager.addListener(updateData);
}

function updateData(timeInfo) {
    const currentSeconds = timeInfo ? timeInfo.seconds : timeManager.getCurrentSeconds();
    updateClock(currentSeconds);
    
    const activeTrips = tripScheduler.getActiveTrips(currentSeconds);
    
    const busesWithPositions = activeTrips
        .map(tripInfo => {
            const position = busPositionCalculator.calculatePosition(tripInfo, currentSeconds);
            if (position) {
                return {
                    tripId: tripInfo.tripId,
                    route: tripInfo.route,
                    position: position,
                    segment: tripInfo.segment,
                    currentSeconds: currentSeconds
                };
            }
            return null;
        })
        .filter(bus => bus !== null)
        .filter(bus => visibleRoutes.has(bus.route.route_id));
    
    mapRenderer.updateBusMarkers(busesWithPositions, tripScheduler, currentSeconds);
    
    const visibleBusCount = busesWithPositions.length;
    const totalBusCount = activeTrips.length;
    updateBusCount(visibleBusCount, totalBusCount);
}

function updateClock(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    document.getElementById('current-time').textContent = timeString;
    
    const now = new Date();
    const dateString = now.toLocaleDateString('fr-FR', { 
        weekday: 'short', 
        day: 'numeric', 
        month: 'short' 
    });
    document.getElementById('date-indicator').textContent = dateString;
}

function updateBusCount(visible, total) {
    const busCountElement = document.getElementById('bus-count');
    if (total === visible) {
        busCountElement.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"/>
            </svg>
            ${visible} bus
        `;
    } else {
        busCountElement.innerHTML = `
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"/>
            </svg>
            ${visible} / ${total} bus
        `;
    }
}

function updateDataStatus(message, status = '') {
    const statusElement = document.getElementById('data-status');
    statusElement.textContent = message;
    statusElement.className = status;
}

initializeApp();
